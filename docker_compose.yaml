version: '3.9'

services:
  resource-db:
    image: postgres:17.6-alpine3.22
    restart: always
    environment:
      POSTGRES_USER: ${RESOURCE_POSTGRES_USER_NAME}
      POSTGRES_PASSWORD: ${RESOURCE_POSTGRES_USER_PASSWORD}
      POSTGRES_DB: ${RESOURCE_POSTGRES_DB_NAME}
      PGPORT: ${RESOURCE_POSTGRES_PORT}
    ports:
      - "${RESOURCE_POSTGRES_PORT}:${RESOURCE_POSTGRES_PORT}"
    volumes:
      - ./init-db/resource-db:/docker-entrypoint-initdb.d/

  song-db:
    image: postgres:17.6-alpine3.22
    restart: always
    environment:
      POSTGRES_USER: ${SONG_POSTGRES_USER_NAME}
      POSTGRES_PASSWORD: ${SONG_POSTGRES_USER_PASSWORD}
      POSTGRES_DB: ${SONG_POSTGRES_DB_NAME}
      PGPORT: ${SONG_POSTGRES_PORT}
    ports:
      - "${SONG_POSTGRES_PORT}:${SONG_POSTGRES_PORT}"
    volumes:
      - ./init-db/song-db:/docker-entrypoint-initdb.d/

  resource-service:
    build:
      context: .
      dockerfile: ./resource-service/Dockerfile
    environment:
      - RESOURCE_POSTGRES_CONNECTION_STRING=jdbc:postgresql://${RESOURCE_POSTGRES_HOST}:${RESOURCE_POSTGRES_PORT}/${RESOURCE_POSTGRES_DB_NAME}
      - RESOURCE_POSTGRES_USER_NAME=${RESOURCE_POSTGRES_USER_NAME}
      - RESOURCE_POSTGRES_USER_PASSWORD=${RESOURCE_POSTGRES_USER_PASSWORD}
      - RESOURCE_SERVER_PORT=${RESOURCE_SERVER_PORT}
      - EUREKA_SERVER_ULR=http://${EUREKA_SERVER_HOST}:${EUREKA_SERVER_PORT}/eureka
      - SONG_SERVICE_URL=http://${GATEWAY_SERVER_HOST}:${GATEWAY_SERVER_PORT}/${SONG_SERVER_HOST}
#    ports:
#      - "${RESOURCE_SERVER_PORT}:${RESOURCE_SERVER_PORT}"
    depends_on:
      - resource-db

  song-service:
    build:
      context: .
      dockerfile: ./song-service/Dockerfile
#    deploy:
#      replicas: 2
    environment:
      - SONG_RESOURCE_POSTGRES_CONNECTION_STRING=jdbc:postgresql://${SONG_POSTGRES_HOST}:${SONG_POSTGRES_PORT}/${SONG_POSTGRES_DB_NAME}
      - SONG_POSTGRES_USER_NAME=${SONG_POSTGRES_USER_NAME}
      - SONG_POSTGRES_USER_PASSWORD=${SONG_POSTGRES_USER_PASSWORD}
      - SONG_SERVER_PORT=${SONG_SERVER_PORT}
      - EUREKA_SERVER_ULR=http://${EUREKA_SERVER_HOST}:${EUREKA_SERVER_PORT}/eureka
#    ports:
#      - "${SONG_SERVER_PORT_START}-${SONG_SERVER_PORT_END}:${SONG_SERVER_PORT}"
    depends_on:
      - song-db

  discovery-service:
    build:
      context: .
      dockerfile: ./discovery-service/Dockerfile
    environment:
      - EUREKA_SERVER_PORT=${EUREKA_SERVER_PORT}
    ports:
      - "${EUREKA_SERVER_PORT}:${EUREKA_SERVER_PORT}"

  gateway-service:
    build:
      context: .
      dockerfile: ./gateway-service/Dockerfile
    environment:
      - GATEWAY_SERVER_PORT=${GATEWAY_SERVER_PORT}
      - EUREKA_SERVER_ULR=http://${EUREKA_SERVER_HOST}:${EUREKA_SERVER_PORT}/eureka
    ports:
      - "${GATEWAY_SERVER_PORT}:${GATEWAY_SERVER_PORT}"
    depends_on:
      - discovery-service
      - resource-service
      - song-service